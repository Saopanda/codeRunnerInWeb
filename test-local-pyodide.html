<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地Pyodide测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .output {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            white-space: pre-wrap;
        }
        .error {
            background: #ffe6e6;
            color: #d00;
        }
        .success {
            background: #e6ffe6;
            color: #060;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>本地Pyodide功能测试</h1>
    
    <div class="test-section">
        <h2>1. 资源加载测试</h2>
        <button onclick="testResourceLoading()">测试资源加载</button>
        <div id="resource-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Pyodide初始化测试</h2>
        <button onclick="testPyodideInit()" id="init-btn">初始化Pyodide</button>
        <div id="init-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Python代码执行测试</h2>
        <button onclick="testPythonExecution()" id="exec-btn" disabled>执行Python代码</button>
        <div id="exec-output" class="output"></div>
    </div>
    
    <div class="test-section">
        <h2>4. 科学计算库测试</h2>
        <button onclick="testScientificLibraries()" id="sci-btn" disabled>测试科学计算库</button>
        <div id="sci-output" class="output"></div>
    </div>

    <script type="module">
        let pyodide = null;
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }
        
        function clear(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }
        
        async function testResourceLoading() {
            clear('resource-output');
            log('resource-output', '开始测试资源加载...');
            
            const resources = [
                '/pyodide/pyodide.js',
                '/pyodide/pyodide.asm.wasm',
                '/pyodide/python_stdlib.zip'
            ];
            
            for (const resource of resources) {
                try {
                    const response = await fetch(resource, { method: 'HEAD' });
                    if (response.ok) {
                        log('resource-output', `✅ ${resource} - 可访问`, 'success');
                    } else {
                        log('resource-output', `❌ ${resource} - 状态: ${response.status}`, 'error');
                    }
                } catch (error) {
                    log('resource-output', `❌ ${resource} - 错误: ${error.message}`, 'error');
                }
            }
        }
        
        async function testPyodideInit() {
            clear('init-output');
            log('init-output', '开始初始化Pyodide...');
            
            try {
                const { loadPyodide } = await import('pyodide');
                log('init-output', 'Pyodide模块加载成功');
                
                pyodide = await loadPyodide({
                    indexURL: '/pyodide/',
                    fullStdLib: false
                });
                
                log('init-output', 'Pyodide初始化成功！', 'success');
                document.getElementById('init-btn').disabled = true;
                document.getElementById('exec-btn').disabled = false;
                document.getElementById('sci-btn').disabled = false;
                
            } catch (error) {
                log('init-output', `Pyodide初始化失败: ${error.message}`, 'error');
            }
        }
        
        async function testPythonExecution() {
            if (!pyodide) {
                log('exec-output', '请先初始化Pyodide', 'error');
                return;
            }
            
            clear('exec-output');
            log('exec-output', '开始执行Python代码...');
            
            const testCode = `
print("Hello from local Pyodide!")
print("Python版本:", __import__('sys').version)

# 测试基本计算
result = 2 + 3 * 4
print(f"计算结果: {result}")

# 测试列表操作
numbers = [1, 2, 3, 4, 5]
squares = [x**2 for x in numbers]
print(f"平方数: {squares}")

# 测试函数
def fibonacci(n):
    if n <= 1:
        return n
    return fibonacci(n-1) + fibonacci(n-2)

print(f"斐波那契数列前10项: {[fibonacci(i) for i in range(10)]}")
`;
            
            try {
                // 重定向Python输出
                pyodide.runPython(`
import sys
from io import StringIO

class OutputCapture:
    def __init__(self):
        self.buffer = StringIO()
    
    def write(self, text):
        self.buffer.write(text)
        # 发送到JavaScript控制台
        print(text, end='')
    
    def flush(self):
        pass

sys.stdout = OutputCapture()
`);
                
                const result = pyodide.runPython(testCode);
                
                if (result !== undefined) {
                    log('exec-output', `返回值: ${result}`);
                }
                
                log('exec-output', 'Python代码执行完成！', 'success');
                
            } catch (error) {
                log('exec-output', `执行错误: ${error.message}`, 'error');
            }
        }
        
        async function testScientificLibraries() {
            if (!pyodide) {
                log('sci-output', '请先初始化Pyodide', 'error');
                return;
            }
            
            clear('sci-output');
            log('sci-output', '开始测试科学计算库...');
            
            const libraries = ['numpy', 'pandas', 'matplotlib'];
            
            for (const lib of libraries) {
                try {
                    log('sci-output', `正在加载 ${lib}...`);
                    await pyodide.loadPackage(lib);
                    log('sci-output', `✅ ${lib} 加载成功`, 'success');
                } catch (error) {
                    log('sci-output', `❌ ${lib} 加载失败: ${error.message}`, 'error');
                }
            }
            
            // 测试NumPy
            try {
                log('sci-output', '测试NumPy功能...');
                pyodide.runPython(`
import numpy as np
arr = np.array([1, 2, 3, 4, 5])
print(f"NumPy数组: {arr}")
print(f"数组形状: {arr.shape}")
print(f"数组类型: {arr.dtype}")
print(f"数组和: {np.sum(arr)}")
print(f"数组均值: {np.mean(arr)}")
`);
                log('sci-output', 'NumPy测试完成！', 'success');
            } catch (error) {
                log('sci-output', `NumPy测试失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载完成后自动测试资源加载
        window.addEventListener('load', () => {
            testResourceLoading();
        });
    </script>
</body>
</html>
